datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

model User {
  id             String   @id @default(uuid())
  email          String   @unique
  passwordHash   String
  displayName    String?
  trustScore     Int      @default(50)
  isPremium      Boolean  @default(false)
  roomsUsedToday Int      @default(0)
  lastRoomReset  DateTime @default(now())
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  messages       Message[]
  participants   RoomParticipant[]
  reportsMade    Report[]          @relation("reporter")
  reportsAgainst Report[]          @relation("reported")
  subscription   Subscription?
}

model Room {
  id              String    @id @default(uuid())
  type            String // quick-chat, group-prompt, confession, task-collab, listening-circle
  title           String
  prompt          String?
  rules           String    @default("Be respectful. No personal info sharing. Listen actively.")
  maxParticipants Int       @default(2)
  durationMinutes Int       @default(5)
  status          String    @default("waiting") // waiting, active, ending, closed
  isPremium       Boolean   @default(false)
  startedAt       DateTime?
  closedAt        DateTime?
  createdAt       DateTime  @default(now())

  participants RoomParticipant[]
  messages     Message[]
  reports      Report[]
}

model RoomParticipant {
  id       String    @id @default(uuid())
  userId   String
  roomId   String
  alias    String // anonymous display name, e.g. "Traveler", "Dreamer"
  joinedAt DateTime  @default(now())
  leftAt   DateTime?

  user User @relation(fields: [userId], references: [id])
  room Room @relation(fields: [roomId], references: [id])

  @@unique([userId, roomId])
}

model Message {
  id        String   @id @default(uuid())
  content   String
  userId    String
  roomId    String
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id])
  room Room @relation(fields: [roomId], references: [id])
}

model Report {
  id          String   @id @default(uuid())
  reason      String // harassment, spam, inappropriate, other
  description String?
  roomId      String
  reporterId  String
  reportedId  String
  status      String   @default("pending") // pending, reviewed, resolved
  createdAt   DateTime @default(now())

  room     Room @relation(fields: [roomId], references: [id])
  reporter User @relation("reporter", fields: [reporterId], references: [id])
  reported User @relation("reported", fields: [reportedId], references: [id])
}

model Subscription {
  id               String    @id @default(uuid())
  userId           String    @unique
  stripeCustomerId String?
  stripeSubId      String?
  plan             String    @default("free") // free, premium
  status           String    @default("active") // active, cancelled, past_due
  currentPeriodEnd DateTime?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  user User @relation(fields: [userId], references: [id])
}
